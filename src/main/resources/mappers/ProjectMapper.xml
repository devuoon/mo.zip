<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTO Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.mozip.domain.project.ProjectRepository">
    <resultMap id="projectDtoMap" type="com.mozip.dto.resp.ProjectListDto">
        <result property="id" column="ID"/>
        <result property="projectName" column="PROJECT_NAME"/>
        <result property="projectType" column="PROJECT_TYPE"/>
        <result property="projectInfo" column="PROJECT_INFO"/>
        <result property="views" column="VIEWS"/>
    </resultMap>

    <resultMap id="recruitDtoMap" type="com.mozip.dto.resp.RecruitListDto">
        <result property="id" column="ID"/>
        <result property="projectName" column="PROJECT_NAME"/>
        <result property="projectType" column="PROJECT_TYPE"/>
        <result property="projectInfo" column="PROJECT_INFO"/>
        <result property="views" column="VIEWS"/>
        <result property="status" column="STATUS"/>
        <result property="createTime" column="CREATED_AT"/>
    </resultMap>

    <resultMap id="ShowListDtoMap" type="com.mozip.dto.resp.ShowListDto">
        <result property="id" column="ID"/>
        <result property="projectName" column="PROJECT_NAME"/>
        <result property="projectType" column="PROJECT_TYPE"/>
        <result property="views" column="VIEWS"/>
        <result property="isShow" column="IS_SHOW"/>
    </resultMap>

    <!--  메인페이지 : 새로운 프로젝트  -->
    <resultMap id="projectDetailMap" type="com.mozip.dto.resp.ProjectDetailDto">
        <result property="id" column="ID"/>
        <result property="projectType" column="PROJECT_TYPE"/>
        <result property="status" column="STATUS"/>
        <result property="projectName" column="PROJECT_NAME"/>
        <result property="createdAt" column="CREATED_AT"/>
        <result property="recruitCount" column="RECRUIT_COUNT"/>
        <result property="views" column="VIEWS"/>
        <result property="projectProcess" column="PROJECT_PROCESS"/>
        <result property="projectPurpose" column="PROJECT_PURPOSE"/>
        <result property="exceptTime" column="EXCEPT_TIME"/>
        <result property="exceptDate" column="EXCEPT_DATE"/>
        <result property="projectTime" column="PROJECT_TIME"/>
        <result property="projectInfo" column="PROJECT_INFO"/>
        <result property="ownerId" column="OWNER_ID"/>
    </resultMap>

    <select id="findNewProject" resultMap="projectDtoMap">
        <![CDATA[
        SELECT ID, PROJECT_NAME, PROJECT_TYPE, PROJECT_INFO, VIEWS
        FROM PROJECT
        ORDER BY CREATED_AT DESC
            LIMIT 6
        ]]>
    </select>

    <!--  메인페이지 : 인기 프로젝트  -->
    <select id="findHotProject" resultMap="projectDtoMap">
        <![CDATA[
        SELECT ID, PROJECT_NAME, PROJECT_TYPE, PROJECT_INFO, VIEWS
        FROM PROJECT
        ORDER BY VIEWS DESC
            LIMIT 6
        ]]>
    </select>

    <!--  메인페이지 : 모집역활  -->
    <select id="findRecruitRoles" resultType="java.lang.String">
        SELECT r.ROLE_NAME
        FROM PROJECT p
                 INNER JOIN RECRUIT_ROLE r ON p.ID = r.PROJECT_ID
        WHERE PROJECT_ID = #{projectId}
    </select>

    <!--  메인페이지 : 북마크 카운트  -->
    <select id="findBookmarkCount" resultType="int">
        SELECT COUNT(*)
        FROM PROJECT p
                 INNER JOIN BOOKMARK b ON p.ID = b.PROJECT_ID
        WHERE b.PROJECT_ID = #{projectId}
    </select>

    <!--  리스트페이지 : 모든 프로젝트  -->
    <select id="findAllProject" resultMap="recruitDtoMap">
        SELECT ID, PROJECT_NAME, PROJECT_INFO, PROJECT_TYPE, VIEWS, STATUS, CREATED_AT
        FROM PROJECT
        ORDER BY CREATED_AT DESC
    </select>

    <!--  메인페이지 : 신청자 카운트  -->
    <select id="findSubscribeCount" resultType="java.lang.Integer">
        SELECT COUNT(*)
        FROM SUBSCRIBE
                 INNER JOIN PROJECT ON SUBSCRIBE.PROJECT_ID = PROJECT.ID
        WHERE PROJECT.ID = #{projectId}
    </select>

    <!--  프로젝트자랑페이지 : 모든 프로젝트자랑  -->
    <select id="findAllShowProject" resultMap="ShowListDtoMap">
        SELECT ID, PROJECT_NAME, PROJECT_TYPE, OWNER_ID, VIEWS, IS_SHOW
        FROM PROJECT
        WHERE IS_SHOW = 0
    </select>

    <!--  프로젝트자랑페이지 : 팀네임  -->
    <select id="findTeamName" resultType="java.lang.String">
        SELECT TEAM_NAME
        FROM TEAM_NOTE
                 INNER JOIN PROJECT ON TEAM_NOTE.PROJECT_ID = PROJECT.ID
        WHERE PROJECT_ID = #{projectId}
    </select>

    <!--  프로젝트자랑페이지 : 새로운 프로젝트  -->
    <select id="findHotShow" resultMap="ShowListDtoMap">
        <![CDATA[
        SELECT ID, PROJECT_NAME, PROJECT_TYPE, VIEWS, IS_SHOW
        FROM PROJECT
        WHERE IS_SHOW = 0
        ORDER BY VIEWS DESC
            LIMIT 3
        ]]>
    </select>

    <!--  프로젝트자랑페이지 : 좋아요 카운트  -->
    <select id="findLikeCount" resultType="java.lang.Integer">
        SELECT COUNT(*)
        FROM LIKES
                 INNER JOIN PROJECT ON LIKES.PROJECT_ID = PROJECT.ID
        WHERE PROJECT_ID = #{projectId}
    </select>

    <select id="findProjectDetail" resultMap="projectDetailMap">
        SELECT ID,
               PROJECT_TYPE,
               STATUS,
               PROJECT_NAME,
               CREATED_AT,
               RECRUIT_COUNT,
               VIEWS,
               PROJECT_PROCESS,
               PROJECT_PURPOSE,
               EXCEPT_TIME,
               EXCEPT_DATE,
               PROJECT_TIME,
               PROJECT_INFO,
               OWNER_ID
        FROM PROJECT
        WHERE ID = #{projectId}
    </select>

    <select id="findProjectMemberCount" resultType="int">
        SELECT COUNT(*)
        FROM MEMBER
        WHERE ID IN (SELECT pm.MEMBER_ID
                     FROM PROJECT p
                              INNER JOIN PROJECT_MEMBER pm ON p.ID = pm.PROJECT_ID
                     WHERE P.ID = #{projectId})
    </select>

    <select id="findOwnerInfo" resultType="com.mozip.dto.resp.ProjectMemberDto">
        SELECT ID,
               USERNAME,
               IFNULL(POSITION, '수정필요!'),
               IFNULL(CAREER, 0),
               PROFILE_IMAGE_URL,
               CREATED_AT
        FROM MEMBER
        WHERE ID = #{ownerId}
    </select>

    <select id="findProjectSkills" resultType="java.lang.String">
        SELECT ps.SKILL_NAME
        FROM PROJECT p
                 INNER JOIN PROJECT_SKILL ps ON p.ID = ps.PROJECT_ID
        WHERE p.ID = #{projectId}
    </select>

    <select id="findProjectRecruitRoles" resultType="java.lang.String">
        SELECT r.ROLE_NAME
        FROM PROJECT p
                 INNER JOIN RECRUIT_ROLE r ON p.ID = r.PROJECT_ID
        WHERE p.ID = #{projectId}
    </select>

    <select id="findProjectMembers" resultType="com.mozip.dto.resp.ProjectMemberDto">
        SELECT MEMBER_ID, USERNAME, IFNULL(POSITION, '수정필요!'), IFNULL(CAREER, 0), PROFILE_IMAGE_URL, STIME
        FROM (SELECT SUBSCRIBE.MEMBER_ID, SUBSCRIBE.CREATED_AT AS STIME
              FROM SUBSCRIBE
                       INNER JOIN PROJECT ON PROJECT.ID = SUBSCRIBE.PROJECT_ID
              WHERE PROJECT_ID = #{projectId})
                 INNER JOIN MEMBER ON MEMBER_ID = MEMBER.ID
    </select>

    <!-- 프로젝트 자랑 상세페이지(show_detail) -->
    <resultMap id="ShowDetailDtoMap" type="com.mozip.dto.resp.ShowDetailDto">
        <result property="id" column="ID"/>
        <result property="projectType" column="PROJECT_TYPE"/>
        <result property="projectName" column="PROJECT_NAME"/>
        <result property="createdAt" column="CREATED_AT"/>
        <result property="modifiedShow" column="MODIFIED_SHOW"/>
        <result property="views" column="VIEWS"/>
        <result property="projectProcess" column="PROJECT_PROCESS"/>
        <result property="projectPurpose" column="PROJECT_PURPOSE"/>
        <result property="projectTime" column="PROJECT_TIME"/>
        <result property="recruitCount" column="RECRUIT_COUNT"/>
        <result property="projectInfo" column="PROJECT_INFO"/>
        <result property="ownerId" column="OWNER_ID"/>
        <result property="githubLink" column="GITHUB_LINK"/>
    </resultMap>

    <select id="findShowDetail" resultMap="ShowDetailDtoMap">
        SELECT ID,
               PROJECT_TYPE,
               PROJECT_NAME,
               CREATED_AT,
               MODIFIED_SHOW,
               VIEWS,
               PROJECT_PROCESS,
               PROJECT_PURPOSE,
               PROJECT_TIME,
               RECRUIT_COUNT,
               PROJECT_INFO,
               OWNER_ID,
               GITHUB_LINK
        FROM PROJECT
        WHERE ID = #{projectId}
    </select>

    <!-- 좋아요 카운트 -->
    <select id="findShowLikeCount" resultType="java.lang.Integer">
        SELECT COUNT(*)
        FROM LIKES
                 INNER JOIN PROJECT ON LIKES.PROJECT_ID = PROJECT.ID
        WHERE PROJECT_ID = #{projectId}
    </select>

    <!--참여 인원수-->
    <select id="findShowMemberCount" resultType="int">
        SELECT COUNT(*)
        FROM MEMBER
        WHERE ID IN (SELECT pm.MEMBER_ID
                     FROM PROJECT p
                              INNER JOIN PROJECT_MEMBER pm ON p.ID = pm.PROJECT_ID
                     WHERE P.ID = #{projectId})
    </select>

    <!-- 작성자 프로필 정보 가져오기 / !! 프로필 url 추가 해야함 !! -->
    <select id="findShowOwnerInfo" resultType="com.mozip.dto.resp.ProjectMemberDto">
        SELECT p.ID, USERNAME, POSITION, CAREER, m.PROFILE_IMAGE_URL, m.CREATED_AT
        FROM MEMBER m
                 INNER JOIN PROJECT p ON m.ID = p.OWNER_ID
        WHERE p.Id = #{projectId}
          AND p.OWNER_ID = #{ownerId}
    </select>

    <!-- 기술 스택 가져오기 -->
    <select id="findShowSkills" resultType="java.lang.String">
        SELECT ps.SKILL_NAME
        FROM PROJECT p
                 INNER JOIN PROJECT_SKILL ps ON p.ID = ps.PROJECT_ID
        WHERE p.ID = #{projectId}
    </select>

    <!-- 모집 분야 가져오기 -->
    <select id="findShowRecruitRoles" resultType="java.lang.String">
        SELECT r.ROLE_NAME
        FROM PROJECT p
                 INNER JOIN RECRUIT_ROLE r ON p.ID = r.PROJECT_ID
        WHERE p.ID = #{projectId}
    </select>

    <insert id="createProject" parameterType="com.mozip.dto.req.ProjectCreateDto">
        INSERT INTO PROJECT (PROJECT_NAME, PROJECT_TYPE, SUBJECT,
                             RECRUIT_COUNT, PROJECT_PURPOSE, PROJECT_TIME,
                             PROJECT_PROCESS, EXCEPT_DATE, EXCEPT_TIME, OWNER_ID, PROJECT_INFO, STATUS, CREATED_AT,
                             VIEWS)
        VALUES (#{dto.projectName}, #{dto.projectType}, #{dto.subject},
                #{dto.recruitCount}, #{dto.projectPurpose}, #{dto.projectTime},
                #{dto.projectProcess}, #{dto.exceptDate}, #{dto.exceptTime}, #{dto.ownerId},
                #{dto.projectInfo}, 1, NOW(), 0)
    </insert>

    <insert id="createProjectSkill">
        INSERT INTO PROJECT_SKILL (SKILL_NAME, PROJECT_ID)
        VALUES (#{skill}, #{id})

    </insert>

    <insert id="createRecruitRole">
        INSERT INTO RECRUIT_ROLE (PROJECT_ID, ROLE_NAME)
        VALUES (#{id}, #{role})
    </insert>

    <select id="findProjectId" resultType="java.lang.Integer">
        SELECT ID
        FROM PROJECT
        WHERE PROJECT_NAME = #{projectName}
    </select>

    <select id="findProjectName" resultType="java.lang.String">
        SELECT PROJECT_NAME
        FROM PROJECT
        WHERE PROJECT_NAME = #{projectName}
    </select>

    <!-- 조회수 올리기 -->
    <update id="findViewCount" parameterType="int">
        UPDATE PROJECT
        SET VIEWS = VIEWS + 1
        WHERE ID = #{projectId}
    </update>

    <!--  프로젝트자랑 삭제  -->
    <delete id="deleteProject" parameterType="int">
        DELETE FROM PROJECT WHERE id = #{projectId}
    </delete>

    <!-- 프로젝트자랑 수정 : 기존 데이터 갖고오기 -->
    <select id="editSelectShow" resultType="com.mozip.dto.resp.ShowEditDto">
        SELECT ID,
               PROJECT_TYPE,
               PROJECT_NAME,
               CREATED_AT,
               MODIFIED_SHOW,
               RECRUIT_COUNT,
               PROJECT_PROCESS,
               PROJECT_PURPOSE,
               PROJECT_TIME,
               PROJECT_INFO
        FROM PROJECT
        WHERE ID = #{projectId}
    </select>

    <!-- 프로젝트자랑 수정 : 프로젝트 데이터 수정 -->
    <update id="updateShow" parameterType="com.mozip.dto.resp.ShowEditDto">
        UPDATE PROJECT
        SET PROJECT_TYPE    = #{dto.projectType},
            PROJECT_NAME    = #{dto.projectName},
            CREATED_AT      = #{dto.createdAt},
            MODIFIED_SHOW   = #{dto.modifiedShow},
            RECRUIT_COUNT   = #{dto.recruitCount},
            PROJECT_PROCESS = #{dto.projectProcess},
            PROJECT_PURPOSE = #{dto.projectPurpose},
            PROJECT_TIME    = #{dto.projectTime},
            PROJECT_INFO    = #{dto.projectInfo}
        WHERE ID = #{dto.id}
    </update>

    <!-- 프로젝트모집 상세 : 모집완료 여부 체크 -->
    <select id="recruitDoneCheck" resultType="int">
        SELECT STATUS
        FROM PROJECT
        WHERE ID=#{projectId}
    </select>

    <!-- 프로젝트모집 상세 : 모집완료 -->
    <update id="recruitDoneSuccess" parameterType="int">
        UPDATE PROJECT
        SET STATUS = 0
        WHERE ID = #{projectId}
    </update>

    <!-- 프로젝트모집 상세 : 모집완료 취소 -->
    <update id="recruitDoneCancle" parameterType="int">
        UPDATE PROJECT
        SET STATUS = 1
        WHERE ID = #{projectId}
    </update>

    <!-- 프로젝트모집 수정 : 권한체크 -->
    <select id="findOwnerId" resultType="int">
        SELECT ID
        FROM PROJECT
        WHERE ID=#{projectId} AND OWNER_ID=#{memberId}
    </select>

    <!-- 프로젝트모집 수정 : 기존 데이터 갖고오기 -->
    <select id="findProjectEditDetail" resultType="com.mozip.dto.resp.ProjectEditDto">
        SELECT ID,
               PROJECT_TYPE,
               PROJECT_NAME,
               SUBJECT,
               RECRUIT_COUNT,
               PROJECT_PURPOSE,
               PROJECT_TIME,
               PROJECT_PROCESS,
               EXCEPT_DATE,
               EXCEPT_TIME,
               PROJECT_INFO
        FROM PROJECT
        WHERE ID = #{projectId}
    </select>

    <!-- 프로젝트모집 수정 : 프로젝트 데이터 수정 -->
    <update id="updateRecruitProject" parameterType="com.mozip.dto.resp.ProjectEditDto">
        UPDATE PROJECT
        SET PROJECT_TYPE    = #{dto.projectType},
            PROJECT_NAME    = #{dto.projectName},
            SUBJECT         = #{dto.subject},
            RECRUIT_COUNT   = #{dto.recruitCount},
            PROJECT_PURPOSE = #{dto.projectPurpose},
            PROJECT_TIME    = #{dto.projectTime},
            PROJECT_PROCESS = #{dto.projectProcess},
            EXCEPT_DATE     = #{dto.exceptDate},
            EXCEPT_TIME     = #{dto.exceptTime},
            PROJECT_INFO    = #{dto.projectInfo}
        WHERE ID = #{dto.id}
    </update>

    <!-- 프로젝트모집 수정 : 프로젝트 스킬 -->
    <insert id="updateProjectSkills">
        INSERT INTO PROJECT_SKILL (SKILL_NAME, PROJECT_ID)
        VALUES (#{skill}, #{projectId})
    </insert>

    <!-- 프로젝트모집 수정 : 모집역할 -->
    <insert id="updateProjectRecruitRoles">
        INSERT INTO RECRUIT_ROLE (PROJECT_ID, ROLE_NAME)
        VALUES (#{projectId}, #{role})
    </insert>

    <!-- 프로젝트 스킬 삭제 -->
    <delete id="deleteProjectSkills" parameterType="int">
        DELETE
        FROM PROJECT_SKILL
        WHERE PROJECT_ID = #{projectId}
    </delete>

    <!-- 프로젝트 모집역할 삭제 -->
    <delete id="deleteProjectRecruitRoles" parameterType="int">
        DELETE
        FROM RECRUIT_ROLE
        WHERE PROJECT_ID = #{projectId}
    </delete>

    <!-- 프로젝트모집 프로젝트 신청 -->
    <insert id="projectJoin">
        INSERT INTO SUBSCRIBE (PROJECT_ID, MEMBER_ID, CREATED_AT)
        VALUES (#{projectId}, #{memberId}, NOW())
    </insert>

    <!-- 프로젝트모집 프로젝트 신청 멤버 가져오기 -->
    <select id="findOneJoinMember" resultType="com.mozip.dto.resp.ProjectMemberDto">
        SELECT m.ID, m.USERNAME, m.POSITION, m.CAREER, m.PROFILE_IMAGE_URL, m.CREATED_AT
        FROM SUBSCRIBE s
                 INNER JOIN MEMBER m ON s.MEMBER_ID = m.ID
        WHERE PROJECT_ID = #{projectId}
          AND MEMBER_ID = #{memberId}
    </select>

    <!--  멤버모집리스트 검색하기  -->
    <select id="searchProject" resultMap="recruitDtoMap">
        SELECT P.ID, P.PROJECT_NAME, P.PROJECT_TYPE,
               P.PROJECT_INFO, P.VIEWS, P.STATUS, P.CREATED_AT
        FROM PROJECT P
        WHERE P.PROJECT_NAME LIKE CONCAT('%', #{keyword}, '%')
           OR P.PROJECT_INFO LIKE CONCAT('%', #{keyword}, '%')
        ORDER BY CREATED_AT DESC
    </select>

    <select id="findProjectMemberIdList" resultType="java.lang.Integer">
        SELECT MEMBER_ID
        FROM PROJECT_MEMBER
        WHERE PROJECT_ID = #{projectId}
    </select>

    <!-- 각 필터에 따른 검색 쿼리 -->
    <select id="filterSearch" resultType="java.lang.Integer">
        SELECT p.ID
        FROM PROJECT p
                 INNER JOIN RECRUIT_ROLE pr ON p.ID = pr.PROJECT_ID
        WHERE ROLE_NAME LIKE CONCAT('%', #{filter}, '%')
        ORDER BY CREATED_AT DESC
    </select>

    <!-- 각 셀렉트 필터에 따른 검색 쿼리 -->
    <select id="selectFilter" resultType="java.lang.Integer">
        SELECT ID
        FROM PROJECT
        WHERE STATUS = #{filter}
        ORDER BY CREATED_AT DESC
    </select>

    <!-- 프로젝트타입(사이드, 스터디or모입)에 따른 검색 쿼리 -->
    <select id="projectTypeFilter" resultType="java.lang.Integer">
        SELECT ID
        FROM PROJECT
        WHERE PROJECT_TYPE = #{filter}
        ORDER BY CREATED_AT DESC
    </select>

    <select id="findOneRecruit" resultMap="recruitDtoMap">
        SELECT ID, PROJECT_NAME, PROJECT_TYPE, PROJECT_INFO, VIEWS, STATUS, CREATED_AT
        FROM PROJECT
        WHERE ID = #{projectId}
    </select>

</mapper>
